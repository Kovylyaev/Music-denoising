# Веха 1. ML Design
## Планы:
Договориться про то, по каким метрикам принимаем бейзлайн и последующие модели + про первичную работу с данными (сюда входит и поиск нужных датасетов, и скраппинг если нужного датасета нет, и разметка).

## Результаты:

### Данные
Выбран датасет чистой музыки: https://www.kaggle.com/datasets/andradaolteanu/gtzan-dataset-music-genre-classification
Выбран датасет шума: https://www.kaggle.com/datasets/mlneo07/random-noise-audio

Также, если будет необходимо больше данных, найдены: музыка - https://www.kaggle.com/datasets/imsparsh/musicnet-dataset и https://www.kaggle.com/datasets/soumendraprasad/musical-instruments-sound-dataset, шум - https://www.kaggle.com/datasets/javohirtoshqorgonov/noise-audio-data

В ноубуке находятся скрипты по скачиванию и первичной обработке данных + реализация класса датасета (__getitem__ ->  mel-spec-noised-audio + mel-spec-clean-audio).

Изначально был выбран другой датасет, но он не подошёл(

### Метрики

Каждая из приведенных ниже метрик имеет свои преимущества и ограничения в конкретных задачах оценки разборчивости речи, качества аудиосигнала или степени искажений при обработке. Так как все эти задачи имеют место в обработке музыки от шума, то и рассматривать их можно в совокупности.

- **SNR** --- метрика, показывающая отношение мощности сигнала к мощности шума, удобна для быстрого количественного сравнения.
- **STOI** --- оценивает разборчивость речи через корреляцию отрезков спектральных представлений, что считается важным для восприятия речи.
- **FW-SSMR** --- учитывает частотную специфику ошибок, вычисляя сегментные SNR с весами, что приближает оценку к перцептивной значимости искажений.
- **SDR** --- измеряет отношение полезного сигнала к суммарным искажениям, разделяя ошибки по типам.
- **SRMR** --- позволяет оценить степень реверберационных искажений (reverberation distortions), анализируя модуляционные характеристики речи (modulation characteristics). Не совсем относится к шуму, но может пригодиться.
- **PESQ** --- отражает перцептивное качество речи, моделируя особенности слухового восприятия, но сложно реализуется.
- **MSE** --- стандартная мера среднеквадратичной ошибки, дающая общее представление о числовой близости сигналов.




### Почему выбрана одна метрика, а не другая + обзор метрик

Ниже представлен подробный анализ семи метрик, используемых для оценки качества обработки звука, в частности в задачах шумоподавления. Рассмотрены как классические показатели (SNR, MSE), так и метрики, учитывающие особенности восприятия речи (PESQ, STOI) и специфические аспекты искажений (SDR, SRMR, FW-SSMR).

#### 1. SNR (Signal-to-Noise Ratio)

**Назначение:**  
SNR измеряет отношение мощности полезного сигнала к мощности шума, что позволяет количественно оценить, насколько доминирующим является сигнал над фоновыми помехами.

**Математическое определение:**

Пусть $ x(n) $ --- чистый (эталонный) сигнал, а \( \hat{x}(n) \) --- его версия с шумом. Тогда шум определяется как:
\[
n(n) = x(n) - \hat{x}(n).
\]

Мощность сигнала и шума вычисляются как:
\[
P_{\text{signal}} = \frac{1}{N} \sum_{n=1}^{N} x(n)^2, \quad
P_{\text{noise}} = \frac{1}{N} \sum_{n=1}^{N} \left( x(n) - \hat{x}(n) \right)^2.
\]

Отношение SNR (в децибелах):
\[
\text{SNR (dB)} = 10 \cdot \log_{10}\!\left(\frac{P_{\text{signal}}}{P_{\text{noise}}}\right).
\]

**Вывод:**  
Переход к логарифмической шкале позволяет удобнее сравнивать величины, а SNR является прямой мерой соотношения полезной информации к шуму.

---

#### 2. STOI (Short-Time Objective Intelligibility)

**Назначение:**  
STOI разработана для оценки разборчивости речи и основывается на сравнении коротковременных спектральных представлений чистого и обработанного сигналов.

**Этапы вычисления:**

1. **Разбиение сигналов на фреймы.**  
   Чистый сигнал \( x(n) \) и обработанный \( \hat{x}(n) \) разбиваются на короткие сегменты.

2. **Получение спектральных представлений.**  
   Для каждого фрейма применяется кратковременное преобразование Фурье (STFT) для извлечения временно-частотной информации.

3. **Нормировка и вычисление корреляции.**  
   Для \( k \)-го фрейма вычисляются нормированные спектральные коэффициенты \( X_k(i) \) и \( \hat{X}_k(i) \) по частотным каналам \( i \). Затем определяется коэффициент корреляции:
   \[
   \rho_k = \frac{\sum_{i} \left( X_k(i) - \bar{X}_k \right) \left( \hat{X}_k(i) - \bar{\hat{X}}_k \right)}{\sqrt{\sum_{i} \left( X_k(i) - \bar{X}_k \right)^2 \, \sum_{i} \left( \hat{X}_k(i) - \bar{\hat{X}}_k \right)^2}},
   \]
   где \( \bar{X}_k \) и \( \bar{\hat{X}}_k \) --- средние значения по фрейму.

4. **Агрегирование по фреймам.**  
   Итоговый индекс STOI определяется как среднее значение коэффициентов:
   \[
   \text{STOI} = \frac{1}{K} \sum_{k=1}^{K} \rho_k.
   \]

**Вывод:**  
STOI измеряет степень корреляции между локальными спектральными представлениями, что позволяет оценить, насколько хорошо сохранены ключевые признаки речи после обработки.

---

#### 3. FW-SSMR (Frequency-Weighted Segmental Signal-to-Noise Metric)

**Назначение:**  
FW-SSMR --- модифицированная метрика, которая оценивает качество обработки сигнала по сегментам с учётом частотного распределения ошибок. Такой подход позволяет учитывать то, что ошибки в различных частотных диапазонах влияют на восприятие речи по-разному.

**Подход вычисления:**

1. **Разбиение на сегменты и частотное разложение.**  
   Сигнал разбивается на короткие сегменты \( k = 1, \dots, K \). Для каждого сегмента производится спектральное разложение по полосам \( i \) (например, с использованием фильтров, соответствующих критическим полосам слуха).

2. **Вычисление сегментного SNR с весами.**  
   Для сегмента \( k \) определяются спектральные компоненты чистого сигнала \( S_k(i) \) и обработанного сигнала \( \hat{S}_k(i) \). Весовые коэффициенты \( w(i) \) отражают значимость каждой полосы. Тогда для сегмента:
   \[
   \text{SSMR}_k = 10 \cdot \log_{10}\!\left(\frac{\sum_{i} w(i)\, S_k(i)^2}{\sum_{i} w(i)\, \bigl(S_k(i)-\hat{S}_k(i)\bigr)^2}\right).
   \]

3. **Агрегирование по сегментам.**  
   Итоговое значение метрики определяется как среднее по всем сегментам:
   \[
   \text{FW-SSMR} = \frac{1}{K} \sum_{k=1}^{K} \text{SSMR}_k.
   \]


---



#### 4. SDR (Signal-to-Distortion Ratio)

**Назначение:**  
SDR характеризует отношение полезной (целевой) части сигнала к суммарным искажениям, включающим шум, интерференцию и артефакты, возникающие при обработке.

**Математическая модель:**

Пусть восстановленный сигнал \( \hat{s}(t) \) декомпозируется по следующей модели:
\[
\hat{s}(t) = s_{\text{target}}(t) + e_{\text{interf}}(t) + e_{\text{noise}}(t) + e_{\text{artif}}(t),
\]
где:
- \( s_{\text{target}}(t) \) --- оптимально подобранная проекция истинного сигнала \( s(t) \) на \( \hat{s}(t) \);
- \( e_{\text{interf}}(t) \), \( e_{\text{noise}}(t) \) и \( e_{\text{artif}}(t) \) --- компоненты, отвечающие за интерференцию, шум и артефакты соответственно.

**Формула SDR:**
\[
\text{SDR (dB)} = 10 \cdot \log_{10}\!\left(\frac{\| s_{\text{target}} \|^2}{\| e_{\text{interf}} + e_{\text{noise}} + e_{\text{artif}} \|^2}\right).
\]

**Вывод:**  
При вычислении \( s_{\text{target}}(t) \) часто используется метод наименьших квадратов для нахождения оптимального масштабного коэффициента, минимизирующего ошибку. Затем отношение энергии целевого сигнала к суммарной энергии ошибок переводится в логарифмическую шкалу.

---

#### 5. SRMR (Speech-to-Reverberation Modulation Energy Ratio)

**Назначение:**  
SRMR позволяет оценить степень реверберационных искажений (reverberation distortions), анализируя модуляционные характеристики речи. Реверберация изменяет динамику модуляций, поэтому отношение энергии модуляций, характерных для речи, к энергии, обусловленной реверберацией, служит показателем качества.

**Методика вычисления:**

1. **Банковый анализ.**  
   Сигнал пропускается через набор полосовых фильтров, имитирующих критические полосы слуха, что даёт набор временных рядов \( s_i(t) \) для каждой полосы \( i \).

2. **Переход в модуляционную область.**  
   Для каждого \( s_i(t) \) вычисляется кратковременное преобразование (например, STFT) для получения модуляционного спектра, отражающего амплитудные колебания во временной области.

3. **Разделение диапазонов.**  
   Определяются два диапазона модуляционных частот:
   - \( \mathcal{M}_{\text{speech}} \): диапазон, характерный для динамики речи (низкие модуляционные частоты);
   - \( \mathcal{M}_{\text{reverb}} \): диапазон, в котором доминирует реверберация (более высокие модуляционные частоты).

**Формула:**
\[
\text{SRMR} = \frac{\sum_{m \in \mathcal{M}_{\text{speech}}} E_m}{\sum_{m \in \mathcal{M}_{\text{reverb}}} E_m},
\]
где \( E_m \) --- энергия в \( m \)-м модуляционном канале.

**Вывод:**  
SRMR характеризует баланс между "чистой" речью и реверберационными компонентами, используя анализ динамики модуляций, что особенно полезно при оценке воздействия реверберации на речь. Оценивает немного другую задачу.

---

#### 6. PESQ (Perceptual Evaluation of Speech Quality)

**Назначение:**  
Метрика PESQ разработана в стандарте ITU-T P.862 для объективной оценки качества речи. Она пытается смоделировать восприятие человеком, учитывая не только энергетические, но и перцептивные особенности звука.

**Основные этапы алгоритма:**

1. **Предобработка и временное выравнивание.**  
   Исходный (эталонный) сигнал \( x(n) \) и обработанный сигнал \( \hat{x}(n) \) выравниваются по времени, чтобы компенсировать задержки.

2. **Перцептуальное преобразование.**  
   Оба сигнала пропускаются через модель, имитирующую преобразование, происходящее в слуховой системе человека. Это включает моделирование нелинейного восприятия громкости, частотной характеристики слухового восприятия и т.д. Результатом являются перцептуальные представления \( P_x(n) \) и \( P_{\hat{x}}(n) \).

3. **Вычисление разницы и нелинейное отображение.**  
   На основе разницы 
   \[
   d(n) = P_x(n) - P_{\hat{x}}(n)
   \]
   рассчитывается агрегированная величина, после чего применяется нелинейная функция для получения итогового балла:
   \[
   \text{PESQ} = f\!\left(\sum_{n} w(n) \, |d(n)|^p \right),
   \]
   где \( w(n) \) --- весовые коэффициенты, а параметр \( p \) определяется в процессе калибровки алгоритма.

**Замечание:**  
Детальный математический вывод всех этапов вычисления PESQ отражает сложность моделирования слуховой системы и описан в стандарте ITU-T P.862. В связи с этим универсальной «закрытой» формулы не существует --- метрика определяется комплексным алгоритмом с несколькими нелинейными этапами.

---

#### 7. MSE (Mean Squared Error)
**Обзор:**
Классическая метрика предназаначенная для нормально распределенной ошибки.

**Формула:**
\[
\text{MSE} = \frac{1}{N} \sum_{n=1}^{N} \bigl(x(n) - \hat{x}(n)\bigr)^2,
\]
где:
- \( x(n) \) --- истинное значение сигнала в отсчёте \( n \),
- \( \hat{x}(n) \) --- оценка (восстановленный сигнал) в том же отсчёте.


